<!DOCTYPE html>
<html lang="es-mx">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Registrar Venta</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="vue3.js"></script>

  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body class="bg-light">
  <!-- BARRA DE NAVEGACIÓN-->
<nav class="navbar navbar-expand-lg navbar-dark navbar-custom mb-4">
  <div class="container-fluid">

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">

      <ul class="navbar-nav">

        <!-- Menú Principal (IZQUIERDA) -->
        <li class="nav-item">
          <a class="nav-link" href="menú.html">
            <i class="bi bi-house-door-fill"></i> Menú Principal
          </a>
        </li>

      </ul>

      <!-- Productos y Reportes (DERECHA) -->
      <ul class="navbar-nav ms-auto">

        <li class="nav-item">
          <a class="nav-link" href="detalle_venta.html">
            <i class="bi-receipt"></i> Detalle de venta
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="reportes.html">
            <i class="bi bi-bar-chart-line-fill"></i> Reportes
          </a>
        </li>

      </ul>

    </div>
  </div>
</nav>

<div id="appVue" class="container py-4">

  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Registrar Venta</h2>
  </div>

  <!-- Tarjeta principal -->
  <div class="card shadow-sm">
    <div class="card-header bg-success text-white">Nueva Venta</div>

    <div class="card-body">

      <!-- SELECCIÓN DE TIPO -->
      <div class="mb-3">
        <label class="form-label">Tipo de Producto</label>
        <select class="form-select" v-model="filtroTipo">
          <option value="" disabled>Seleccione el tipo de producto</option>
          <option value="">Todos los tipos</option>
          <option value="B">Base</option>
          <option value="C">Concentrado</option>
          <option value="T">Terminado</option>
        </select>
      </div>

      <!-- SELECCIÓN DE PRODUCTO -->
      <div class="mb-3">
        <label class="form-label">Producto</label>
        <select class="form-select" v-model="productoSeleccionado" @change="asignarProducto">
          <option value="">Seleccione un producto</option>

          <option v-for="p in productosFiltrados"
                  :key="p.id_producto"
                  :value="p.id_producto">
            {{ p.nombre }} ({{ p.unidad_medida }}) - Stock: {{ p.stock }}
          </option>
        </select>
      </div>

      <!-- CANTIDAD -->
      <div class="mb-3">
        <label class="form-label">Cantidad</label>
        <input type="number"
               v-model.number="venta.cantidad"
               @input="calcularTotal"
               :step="venta.unidad_medida === 'pieza' ? 1 : 0.01"
               min="1"
               class="form-control">
      </div>

      <!-- PRECIO UNITARIO -->
      <div class="mb-3">
        <label class="form-label">Precio Unitario</label>
        <input type="number" step="0.01" v-model="venta.precio_unitario" disabled class="form-control">
      </div>

      <!-- TOTAL -->
      <div class="mb-3">
        <label class="form-label">Total</label>
        <input type="text" :value="formatoPrecio(venta.total)" disabled class="form-control">
      </div>

      <!-- BOTONES -->
      <div class="d-flex gap-2 mb-3">
        <button class="btn btn-primary flex-fill" @click="agregarAlCarrito">Agregar al Carrito</button>
        <button class="btn btn-secondary flex-fill" @click="cancelarVenta">Cancelar Producto</button>
      </div>

      <!-- CARRITO -->
<div v-if="carrito.length">

  <h5 class="fw-bold">Productos en venta</h5>

  <!-- Contenedor responsive -->
  <div class="table-responsive">
    <table class="table table-sm table-bordered align-middle">
      <thead class="table-primary">
        <tr>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Precio Unitario</th>
          <th>Total</th>
          <th>Acción</th>
        </tr>
      </thead>

      <tbody>
        <tr v-for="(p, index) in carrito" :key="p.id_producto">
          <td>{{ p.nombre }}</td>
          <td>{{ p.cantidad }}</td>
          <td>{{ formatoPrecio(p.precio_unitario) }}</td>
          <td>{{ formatoPrecio(p.total) }}</td>
          <td class="text-center">
            <button class="btn btn-danger btn-sm" @click="eliminarDelCarrito(index)">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="text-end mb-3">
    <h5>Total de la venta: <strong>{{ formatoPrecio(totalCarrito) }}</strong></h5>
  </div>

  <div class="d-flex gap-2">
    <button class="btn btn-success flex-fill" @click="registrarVentaCarrito">Registrar Venta</button>
    <button class="btn btn-danger flex-fill" @click="cancelarVentaCompleta">Cancelar Venta</button>
  </div>

</div>

  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="venta.js"></script>
</body>
</html>
